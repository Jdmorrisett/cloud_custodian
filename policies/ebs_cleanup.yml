policies:
- name: ebs-delete-marked
  mode:
      type: periodic
      schedule: "cron(0 20 ? * MON-FRI *)"
      role: <C7N_ROLE>
  resource: ebs
  comments: |
    Delete any marked EBS volumes that were scheduled for deletion
  filters:
    - type: marked-for-op
      op: delete
  actions:
    - type: notify
      template: 'standard'
      template_format: 'html'
      priority_header: '1'
      subject: "C7N: Deleting Resources"
      to:
        - resource-owner
      owner_absent_contact:
        - <C7N_OWNER>
      transport:
        type: sqs
        queue: <C7N_QUEUE>
    - delete
- name: ebs-mark-unattached-deletion
  mode:
    type: periodic
    schedule: "cron(0 22 ? * MON-FRI *)"
    role: <C7N_ROLE>
  resource: ebs
  comments: |
    Mark any unattached EBS volumes for deletion in 30 days.
    Volumes set to not delete on instance termination do have
    valid use cases as data drives, but 99% of the time they
    appear to be just garbage creation.
  filters:
    - Attachments: []
    - "tag:maid_status": absent
    - "tag:aws:cloudformation:stack-id": absent
    # - type: value
    #   key: CreateTime
    #   value_type: age
    #   value: 14
    #   op: greater-than
  actions:
    - type: notify
      template: 'standard'
      template_format: 'html'
      priority_header: '1'
      subject: "C7N: Unattached Resources Marked For Deletion"
      to:
        - resource-owner
      owner_absent_contact:
        - <C7N_OWNER>
      transport:
        type: sqs
        queue: <C7N_QUEUE>
    - type: mark-for-op
      op: delete
      days: 1

- name: ebs-unmark-attached-deletion
  mode:
    type: periodic
    schedule: "cron(0 22 ? * MON-FRI *)"
    role: <C7N_ROLE>
  resource: ebs
  comments: |
    Unmark any attached EBS volumes that were scheduled for deletion
    if they are currently attached
  filters:
    - type: value
      key: "Attachments[0].Device"
      value: not-null
    - "tag:maid_status": not-null
  actions:
    - type: notify
      template: 'standard'
      template_format: 'html'
      priority_header: '1'
      subject: Deleting Resources
      to:
        - resource-owner
      owner_absent_contact:
        - <C7N_OWNER>
      transport:
        type: sqs
        queue: <C7N_QUEUE>
    - unmark